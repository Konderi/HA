# Modern electricity price sensors using centralized constants
# HA 2026.6+ compatible - uses template: instead of platform: template
# Created: 2026-02-08

template:
  - sensor:
      # Total electricity price (all components combined)
      - name: "Electricity Total Price (cents)"
        unique_id: electricity_total_price_cents
        unit_of_measurement: "c/kWh"
        device_class: monetary
        state_class: measurement
        state: >
          {% set nordpool = states('sensor.nordpool_kwh_fi_eur_4_10_0') | float(0) %}
          {% set hour = now().hour %}
          {% set is_night_tariff = hour >= 22 or hour < 7 %}
          
          {# Nordpool price already includes energy cost - don't add extra! #}
          {# Transfer price varies by time of day #}
          {% set transfer_price = 3.01 if is_night_tariff else 4.92 %}
          {% set tax = 2.79372 %}
          {% set margin = 0.59 %}
          
          {# Calculate total price in cents/kWh #}
          {# Formula: (Nordpool + Transfer + Tax + Margin) × VAT #}
          {% set total_before_vat = (nordpool * 100) + transfer_price + tax + margin %}
          {% set total_with_vat = total_before_vat * 1.255 %}
          
          {{ total_with_vat | round(2) }}
        attributes:
          nordpool_price_cents: "{{ (states('sensor.nordpool_kwh_fi_eur_4_10_0') | float(0) * 100) | round(2) }}"
          transfer_price: "{{ 3.01 if (now().hour >= 22 or now().hour < 7) else 4.92 }}"
          tax: 2.79372
          margin: 0.59
          vat_multiplier: 1.255
          tariff_type: "{{ 'night (22-07)' if (now().hour >= 22 or now().hour < 7) else 'day (07-22)' }}"
          calculation: "(Nordpool + Transfer + Tax + Margin) × VAT"
