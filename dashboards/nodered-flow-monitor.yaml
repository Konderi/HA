# ============================================================================
# NODE-RED FLOW MONITORING DASHBOARD
# ============================================================================
# Visual monitoring of Phase 2 Node-RED flows
# Shows flow logic, current states, and decision paths
# ============================================================================

title: Node-RED Flows
theme: default
views:
  # ==========================================================================
  # VIEW 1: FLOW OVERVIEW
  # ==========================================================================
  - title: Flow Overview
    path: flow-overview
    icon: mdi:sitemap
    type: custom:vertical-layout
    badges: []
    cards:
      - type: custom:mushroom-chips-card
        chips:
          - type: menu
        alignment: center
      
      - type: custom:mushroom-title-card
        title: ğŸ”„ Node-RED Flow Monitor
        subtitle: Phase 2 Automation System
        alignment: center
      
      # Flow Status Summary
      - type: markdown
        card_mod:
          style: |
            ha-card {
              background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            }
        content: |
          ## ğŸ“Š Active Flows Status
          
          | Flow | Status | Description |
          |------|--------|-------------|
          | ğŸ  Temperature Control | {{ 'âœ… Active' if is_state('input_boolean.kids_home', 'on') or is_state('input_boolean.kids_home', 'off') else 'âŒ Error' }} | Kids room heating automation |
          | âš–ï¸ Priority Balancer | {{ 'âœ… Active' if states('sensor.total_power_kw') else 'âŒ Error' }} | Load management & Tesla control |
          | âš¡ Peak Limiter | {{ 'âœ… Active' if states('sensor.total_power_kw') else 'âŒ Error' }} | Tehomaksu prevention (<8kW) |
          | ğŸ’° Price Optimizer | {{ 'âœ… Active' if states('sensor.electricity_total_price_cents') else 'âŒ Error' }} | Heat pump scheduling |
          | ğŸ“¡ Phase Monitor | {{ 'âœ… Active' if states('sensor.shellyem3_channel_a_current') else 'âŒ Error' }} | Voltage & battery alerts |
          
          **Last Updated:** {{ now().strftime('%H:%M:%S') }}
      
      # Quick Navigation
      - type: horizontal-stack
        cards:
          - type: custom:mushroom-template-card
            primary: Temperature
            secondary: Control Flow
            icon: mdi:thermometer-lines
            icon_color: deep-orange
            layout: vertical
            fill_container: true
            card_mod:
              style: |
                ha-card {
                  background: linear-gradient(135deg, rgba(255, 111, 0, 0.1) 0%, rgba(255, 87, 34, 0.2) 100%);
                }
            tap_action:
              action: navigate
              navigation_path: /nodered-flows/temperature-flow
          
          - type: custom:mushroom-template-card
            primary: Load
            secondary: Balancer
            icon: mdi:scale-balance
            icon_color: green
            layout: vertical
            fill_container: true
            card_mod:
              style: |
                ha-card {
                  background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(46, 125, 50, 0.2) 100%);
                }
            tap_action:
              action: navigate
              navigation_path: /nodered-flows/priority-flow
      
      - type: horizontal-stack
        cards:
          - type: custom:mushroom-template-card
            primary: Peak
            secondary: Limiter
            icon: mdi:alert-octagon
            icon_color: red
            layout: vertical
            fill_container: true
            card_mod:
              style: |
                ha-card {
                  background: linear-gradient(135deg, rgba(244, 67, 54, 0.1) 0%, rgba(211, 47, 47, 0.2) 100%);
                }
            tap_action:
              action: navigate
              navigation_path: /nodered-flows/peak-flow
          
          - type: custom:mushroom-template-card
            primary: Price
            secondary: Optimizer
            icon: mdi:currency-eur
            icon_color: amber
            layout: vertical
            fill_container: true
            card_mod:
              style: |
                ha-card {
                  background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 160, 0, 0.2) 100%);
                }
            tap_action:
              action: navigate
              navigation_path: /nodered-flows/price-flow
      
      # System Health
      - type: entities
        title: ğŸ¥ System Health
        card_mod:
          style: |
            ha-card {
              background: rgba(var(--rgb-primary-text-color), 0.05);
            }
        entities:
          - entity: sensor.total_power_kw
            name: Power Sensor
            icon: mdi:lightning-bolt
          - entity: sensor.electricity_total_price_cents
            name: Price Sensor
            icon: mdi:currency-eur
          - entity: input_boolean.kids_home
            name: Kids Toggle
            icon: mdi:human-child
          - entity: switch.mh1
            name: MH1 Radiator
            icon: mdi:radiator

  # ==========================================================================
  # VIEW 2: TEMPERATURE CONTROL FLOW
  # ==========================================================================
  - title: Temperature Flow
    path: temperature-flow
    icon: mdi:thermometer-lines
    type: custom:vertical-layout
    badges: []
    cards:
      - type: custom:mushroom-chips-card
        chips:
          - type: back
        alignment: center
      
      - type: custom:mushroom-title-card
        title: ğŸ  Temperature Control Flow
        alignment: center
      
      # Flow Diagram
      - type: markdown
        card_mod:
          style: |
            ha-card {
              background: rgba(var(--rgb-primary-text-color), 0.05);
              font-family: monospace;
            }
        content: |
          ```
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  TEMPERATURE-BASED RADIATOR CONTROL FLOW       â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          
          START: Every 5 minutes
               â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Check Kids Home?   â”‚ â† input_boolean.kids_home
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   YES       â”‚     NO      â”‚
          â†“             â†“
          ğŸ”¥ Target:    â„ï¸ Minimum:
          {{ states('input_number.kids_rooms_target_temp') }}Â°C       {{ states('input_number.kids_rooms_min_temp') }}Â°C
          
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  ROOM-BY-ROOM CONTROL                          â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          
          ğŸ‘¦ TUOMAS ROOM
          Current: {{ states('sensor.aqara_poikienhuone_temperature') }}Â°C
          Radiator: {{ 'ON ğŸ”¥' if is_state('switch.shellypro4pm_ec62609fd3dc_switch_1', 'on') else 'OFF â„ï¸' }}
          
          ğŸ‘§ SARA ROOM
          Current: {{ states('sensor.aqara_saranhuone_temperature') }}Â°C
          Radiator: {{ 'ON ğŸ”¥' if is_state('switch.shellypro4pm_ec62609fd3dc_switch_0', 'on') else 'OFF â„ï¸' }}
          
          ğŸ›ï¸ MASTER BEDROOM (MH1)
          Current: {{ states('sensor.aqara_makuuhuone_temperature') }}Â°C
          Radiator: {{ 'ON ğŸ”¥' if is_state('switch.mh1', 'on') else 'OFF â„ï¸' }}
          Schedule: {{ states('input_datetime.mh1_start_time')[:5] }} - {{ states('input_datetime.mh1_end_time')[:5] }}
          Target: {{ states('input_number.mh1_target_temp') }}Â°C
          Manual: {{ 'YES' if is_state('input_boolean.mh1_manual_override', 'on') else 'NO' }}
          
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  DECISION LOGIC                                â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          
          IF temp < target - 0.5Â°C â†’ Turn ON ğŸ”¥
          IF temp > target + 0.5Â°C â†’ Turn OFF â„ï¸
          ELSE â†’ Keep current state â¸ï¸
          ```
      
      # Current State
      - type: horizontal-stack
        cards:
          - type: custom:mushroom-template-card
            primary: Kids Home
            secondary: '{{ "YES - Target " + states("input_number.kids_rooms_target_temp") + "Â°C" if is_state("input_boolean.kids_home", "on") else "NO - Min " + states("input_number.kids_rooms_min_temp") + "Â°C" }}'
            icon: mdi:human-child
            icon_color: '{{ "green" if is_state("input_boolean.kids_home", "on") else "blue" }}'
            layout: vertical
            card_mod:
              style: |
                ha-card {
                  background: rgba(var(--rgb-primary-text-color), 0.05);
                }
          
          - type: custom:mushroom-template-card
            primary: Active Radiators
            secondary: '{{ states.switch | selectattr("entity_id", "in", ["switch.shellypro4pm_ec62609fd3dc_switch_0", "switch.shellypro4pm_ec62609fd3dc_switch_1", "switch.mh1"]) | selectattr("state", "eq", "on") | list | count }} / 3'
            icon: mdi:radiator
            icon_color: deep-orange
            layout: vertical
            card_mod:
              style: |
                ha-card {
                  background: rgba(var(--rgb-primary-text-color), 0.05);
                }

  # ==========================================================================
  # VIEW 3: PRIORITY LOAD BALANCER FLOW
  # ==========================================================================
  - title: Priority Flow
    path: priority-flow
    icon: mdi:scale-balance
    type: custom:vertical-layout
    badges: []
    cards:
      - type: custom:mushroom-chips-card
        chips:
          - type: back
        alignment: center
      
      - type: custom:mushroom-title-card
        title: âš–ï¸ Priority Load Balancer
        alignment: center
      
      # Flow Diagram
      - type: markdown
        card_mod:
          style: |
            ha-card {
              background: rgba(var(--rgb-primary-text-color), 0.05);
              font-family: monospace;
            }
        content: |
          ```
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  PRIORITY LOAD BALANCER FLOW                   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          
          START: Power change detected
               â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Current Power       â”‚
          â”‚ {{ states('sensor.total_power_kw') }} kW         â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  PRIORITY ORDER (1 = Highest)                  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          
          1ï¸âƒ£  SAUNA (7kW)
              Status: {{ 'ON ğŸ§–' if is_state('switch.sauna_channel_1', 'on') else 'OFF' }}
              Protection: ALWAYS PROTECTED
              â””â”€> If sauna ON â†’ Tesla max 8A
          
          2ï¸âƒ£  HEATING (variable)
              Status: {{ states.switch | selectattr("entity_id", "in", ["switch.shellypro4pm_ec62609fd3dc_switch_0", "switch.shellypro4pm_ec62609fd3dc_switch_1", "switch.mh1"]) | selectattr("state", "eq", "on") | list | count }} radiators ON
              Protection: HIGH PRIORITY
          
          3ï¸âƒ£  BOILER (3kW)
              Status: {{ 'ON ğŸ’§' if is_state('switch.shellypro4pm_ec62609fd3dc_switch_2', 'on') else 'OFF' }}
              Protection: MEDIUM PRIORITY
          
          4ï¸âƒ£  TESLA CHARGING
              Status: {{ 'ON ğŸš—' if is_state('switch.tesla_model_3_charger', 'on') else 'OFF' }}
              Current Amps: {{ states('number.tesla_model_3_charging_amps') }}A
              Protection: ADJUSTABLE (6-16A)
          
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  CAPACITY MANAGEMENT                           â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          
          Total Capacity: 17.25 kW (25A Ã— 3 phases)
          Current Usage: {{ states('sensor.total_power_kw') }} kW ({{ (states('sensor.total_power_kw')|float / 17.25 * 100) | round(1) }}%)
          
          {% set power = states('sensor.total_power_kw')|float %}
          {% if power < 8 %}
          Status: âœ… NORMAL - All devices allowed
          {% elif power < 12 %}
          Status: âš ï¸ MEDIUM LOAD - Monitoring
          {% elif power < 14.66 %}
          Status: ğŸŸ  HIGH LOAD (>85%) - Reducing Tesla
          {% else %}
          Status: ğŸ”´ CRITICAL LOAD (>95%) - Tesla minimum
          {% endif %}
          
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  TESLA ADJUSTMENT LOGIC                        â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          
          Sauna ON? {{ 'ğŸ§– YES' if is_state('switch.sauna_channel_1', 'on') else 'NO' }}
          {% if is_state('switch.sauna_channel_1', 'on') %}
          â””â”€> Tesla: 8A max (~5.5kW)
          {% else %}
          Power > 85%? {{ 'âš ï¸ YES' if (states('sensor.total_power_kw')|float / 17.25) > 0.85 else 'NO' }}
          {% if (states('sensor.total_power_kw')|float / 17.25) > 0.85 %}
          â””â”€> Tesla: Reduce by 2A gradually
          {% endif %}
          
          Power > 95%? {{ 'ğŸ”´ YES' if (states('sensor.total_power_kw')|float / 17.25) > 0.95 else 'NO' }}
          {% if (states('sensor.total_power_kw')|float / 17.25) > 0.95 %}
          â””â”€> Tesla: 6A minimum or OFF
          {% endif %}
          {% endif %}
          ```
      
      # Current Actions
      - type: horizontal-stack
        cards:
          - type: gauge
            entity: sensor.total_power_kw
            name: Load Level
            min: 0
            max: 17.25
            needle: true
            card_mod:
              style: |
                ha-card {
                  background: rgba(var(--rgb-primary-text-color), 0.05);
                }
            segments:
              - from: 0
                color: '#4ECDC4'
              - from: 14.66
                color: '#FFE66D'
              - from: 16.39
                color: '#FF6B6B'
          
          - type: custom:mushroom-template-card
            primary: Tesla Status
            secondary: '{{ states("number.tesla_model_3_charging_amps") }}A / {{ "ON" if is_state("switch.tesla_model_3_charger", "on") else "OFF" }}'
            icon: mdi:car-electric
            icon_color: '{{ "green" if is_state("switch.tesla_model_3_charger", "on") else "grey" }}'
            layout: vertical
            card_mod:
              style: |
                ha-card {
                  background: rgba(var(--rgb-primary-text-color), 0.05);
                }

  # ==========================================================================
  # VIEW 4: PEAK POWER LIMITER FLOW
  # ==========================================================================
  - title: Peak Limiter
    path: peak-flow
    icon: mdi:alert-octagon
    type: custom:vertical-layout
    badges: []
    cards:
      - type: custom:mushroom-chips-card
        chips:
          - type: back
        alignment: center
      
      - type: custom:mushroom-title-card
        title: âš¡ Peak Power Limiter
        alignment: center
      
      # Flow Diagram
      - type: markdown
        card_mod:
          style: |
            ha-card {
              background: rgba(var(--rgb-primary-text-color), 0.05);
              font-family: monospace;
            }
        content: |
          ```
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  PEAK POWER LIMITER FLOW (Tehomaksu)          â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          
          PURPOSE: Prevent >8kW 60-minute average
          COST: â‚¬8.38/month per 100W over threshold
          TARGET: Stay below 8kW average
          
          START: Every 30 seconds
               â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Calculate 60-min    â”‚
          â”‚ rolling average     â”‚
          â”‚ {{ states('sensor.total_power_kw') }} kW current  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Average > 7.5kW?   â”‚ â† Early warning threshold
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚     NO      â”‚     YES     â”‚
          â†“             â†“
          âœ… OK         âš ï¸ WARNING
          Continue      â†“
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  Average > 8.0kW?   â”‚ â† Critical threshold
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚     NO      â”‚     YES     â”‚
                   â†“             â†“
                   Monitor       ğŸ”´ ACTION
                                 â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  REDUCTION SEQUENCE                            â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          
          Step 1: Tesla Reduction
                  {{ 'Current: ' + states('number.tesla_model_3_charging_amps') + 'A' }}
                  â”œâ”€> If >6A: Reduce to 6A (-2A steps)
                  â””â”€> If 6A: Turn OFF charger
          
          Step 2: Boiler Control (if needed)
                  {{ 'Status: ' + ('ON' if is_state('switch.shellypro4pm_ec62609fd3dc_switch_2', 'on') else 'OFF') }}
                  â””â”€> Turn OFF for 30 minutes
          
          Step 3: Alert User
                  â””â”€> Notification sent
                  â””â”€> Manual intervention needed
          
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  CURRENT STATUS                                â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          
          Current Power: {{ states('sensor.total_power_kw') }} kW
          {% set power = states('sensor.total_power_kw')|float %}
          Status: {% if power < 7.5 %}âœ… SAFE (<7.5kW)
          {% elif power < 8.0 %}âš ï¸ CLOSE TO LIMIT (7.5-8.0kW)
          {% else %}ğŸ”´ OVER LIMIT (>8.0kW) - REDUCING
          {% endif %}
          
          Protected Devices:
          - ğŸ§– Sauna: {{ 'ON (Protected)' if is_state('switch.sauna_channel_1', 'on') else 'OFF' }}
          - ğŸ  Heating: Always protected
          
          Adjustable Devices:
          - ğŸš— Tesla: {{ states('number.tesla_model_3_charging_amps') }}A ({{ 'Adjustable' if is_state('switch.tesla_model_3_charger', 'on') else 'OFF' }})
          - ğŸ’§ Boiler: {{ 'ON' if is_state('switch.shellypro4pm_ec62609fd3dc_switch_2', 'on') else 'OFF' }}
          ```
      
      # Tehomaksu Calculator
      - type: entities
        title: ğŸ’¶ Tehomaksu Impact
        card_mod:
          style: |
            ha-card {
              background: rgba(var(--rgb-primary-text-color), 0.05);
            }
        entities:
          - type: custom:template-entity-row
            name: Current Average
            state: '{{ states("sensor.total_power_kw") }} kW'
            icon: mdi:chart-line
          - type: custom:template-entity-row
            name: Over Limit
            state: '{{ [0, (states("sensor.total_power_kw")|float - 8.0)] | max | round(2) }} kW'
            icon: mdi:alert
          - type: custom:template-entity-row
            name: Monthly Cost (if sustained)
            state: '{{ ([0, (states("sensor.total_power_kw")|float - 8.0)] | max * 1000 / 100 * 8.38) | round(2) }} â‚¬'
            icon: mdi:currency-eur

  # ==========================================================================
  # VIEW 5: PRICE OPTIMIZER FLOW
  # ==========================================================================
  - title: Price Optimizer
    path: price-flow
    icon: mdi:currency-eur
    type: custom:vertical-layout
    badges: []
    cards:
      - type: custom:mushroom-chips-card
        chips:
          - type: back
        alignment: center
      
      - type: custom:mushroom-title-card
        title: ğŸ’° Price-Based Optimizer
        alignment: center
      
      # Flow Diagram
      - type: markdown
        card_mod:
          style: |
            ha-card {
              background: rgba(var(--rgb-primary-text-color), 0.05);
              font-family: monospace;
            }
        content: |
          ```
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  PRICE-BASED HEAT PUMP OPTIMIZER               â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          
          PURPOSE: Run heat pump during cheapest hours
          TARGET: Minimize electricity cost
          
          START: Every hour (at :00)
               â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Get current price   â”‚
          â”‚ {{ states('sensor.electricity_total_price_cents') }} c/kWh     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  PRICE CLASSIFICATION                          â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          
          {% set price = states('sensor.electricity_total_price_cents')|float %}
          Current: {{ price }} c/kWh
          
          {% if price < 12 %}
          Category: ğŸ’š VERY CHEAP (<12 c/kWh)
          Action: Heat pump ON, boost heating
          {% elif price < 16 %}
          Category: ğŸ’› CHEAP (12-16 c/kWh)
          Action: Heat pump ON, normal mode
          {% elif price < 20 %}
          Category: ğŸŸ  MODERATE (16-20 c/kWh)
          Action: Heat pump ON if needed
          {% elif price < 25 %}
          Category: ğŸ”´ EXPENSIVE (20-25 c/kWh)
          Action: Heat pump eco mode
          {% else %}
          Category: â›” VERY EXPENSIVE (>25 c/kWh)
          Action: Heat pump OFF unless critical
          {% endif %}
          
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  HEAT PUMP CONTROL                             â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          
          Status: {{ states('climate.mitsu_ilp') }}
          Current Temp: {{ state_attr('climate.mitsu_ilp', 'current_temperature') }}Â°C
          Target Temp: {{ state_attr('climate.mitsu_ilp', 'temperature') }}Â°C
          
          Next 3 Hours Forecast:
          (Future: Integrate with Nordpool sensor)
          
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  OPTIMIZATION LOGIC                            â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          
          IF price < 12 c/kWh:
            â””â”€> Increase target temp +2Â°C (heat storage)
          
          IF price 12-20 c/kWh:
            â””â”€> Normal target temperature
          
          IF price > 20 c/kWh:
            â””â”€> Decrease target -1Â°C (use stored heat)
          
          IF price > 30 c/kWh:
            â””â”€> Turn OFF (emergency only)
          ```
      
      # Price Status
      - type: horizontal-stack
        cards:
          - type: custom:mushroom-template-card
            primary: Current Price
            secondary: '{{ states("sensor.electricity_total_price_cents") }} c/kWh'
            icon: mdi:currency-eur
            icon_color: |-
              {% set price = states('sensor.electricity_total_price_cents')|float %}
              {% if price < 12 %}green
              {% elif price < 16 %}light-green
              {% elif price < 20 %}amber
              {% elif price < 25 %}deep-orange
              {% else %}red
              {% endif %}
            layout: vertical
            card_mod:
              style: |
                ha-card {
                  background: rgba(var(--rgb-primary-text-color), 0.05);
                }
          
          - type: custom:mushroom-template-card
            primary: Heat Pump
            secondary: '{{ states("climate.mitsu_ilp") }}'
            icon: mdi:heat-pump
            icon_color: green
            layout: vertical
            card_mod:
              style: |
                ha-card {
                  background: rgba(var(--rgb-primary-text-color), 0.05);
                }
