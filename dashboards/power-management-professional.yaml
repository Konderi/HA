# ============================================================================
# PROFESSIONAL POWER MANAGEMENT DASHBOARD - PC/Desktop Version
# ============================================================================
# Comprehensive control center for managing power, heating, and automation
# Optimized for large screens with 4 detailed pages
# ============================================================================

title: Power Management Pro
theme: default
views:
  # ==========================================================================
  # PAGE 1: MONITOR - Real-time Overview
  # ==========================================================================
  - title: Monitor
    path: monitor
    icon: mdi:monitor-dashboard
    type: custom:grid-layout
    badges: []
    cards:
      # Row 1: Key Metrics
      - type: horizontal-stack
        cards:
          - type: gauge
            entity: sensor.total_power_kw
            name: Current Power
            min: 0
            max: 17.25
            needle: true
            severity:
              green: 0
              yellow: 10
              red: 14
          
          - type: gauge
            entity: sensor.current_electricity_cost_rate
            name: Current Price
            min: 0
            max: 50
            needle: true
            unit: c/kWh
            severity:
              green: 0
              yellow: 18
              red: 28
          
          - type: gauge
            entity: sensor.talon_kokonaiskulutus_paiva_kwh
            name: Today's Consumption
            min: 0
            max: 120
            needle: true
            unit: kWh
            severity:
              green: 0
              yellow: 70
              red: 95
          
          - type: gauge
            entity: sensor.average_power_factor
            name: Power Factor
            min: 0
            max: 1
            needle: true
            severity:
              red: 0
              yellow: 0.80
              green: 0.90

      # Row 2: 7-Day Consumption vs Price Chart
      - type: custom:apexcharts-card
        header:
          show: true
          title: âš¡ğŸ’° 7-Day Consumption vs Price - Automation Effectiveness
          show_states: true
          colorize_states: true
        experimental:
          color_threshold: true
        graph_span: 7d
        span:
          start: day
          offset: '-7d'
        yaxis:
          - id: consumption
            min: 0
            decimals: 1
            opposite: false
          - id: price
            min: 0
            max: 60
            decimals: 0
            opposite: true
        apex_config:
          chart:
            height: 350
          legend:
            show: true
            position: top
            fontSize: 14px
          stroke:
            width: [1, 3]
          tooltip:
            shared: true
          xaxis:
            labels:
              format: 'dd.M'
        series:
          - entity: sensor.talon_kokonaiskulutus_tunti_kwh
            yaxis_id: consumption
            name: Consumption (kWh)
            type: area
            color: '#EA8043'
            opacity: 0.7
            group_by:
              func: last
              duration: 1hour
          - entity: sensor.current_electricity_cost_rate
            yaxis_id: price
            name: Price (c/kWh)
            type: line
            stroke_width: 3
            group_by:
              func: last
              duration: 1hour
            color_threshold:
              - value: 0
                color: '#4ECDC4'
              - value: 15
                color: '#FFE66D'
              - value: 25
                color: '#FF9A76'
              - value: 35
                color: '#FF0000'

      # Row 3: Real-time Monitoring
      - type: horizontal-stack
        cards:
          # Phase Currents
          - type: vertical-stack
            cards:
              - type: entities
                title: âš¡ Phase Currents
                show_header_toggle: false
                entities:
                  - entity: sensor.shellyem3_channel_a_current
                    name: Phase A
                    icon: mdi:sine-wave
                  - entity: sensor.shellyem3_channel_b_current
                    name: Phase B
                    icon: mdi:sine-wave
                  - entity: sensor.shellyem3_channel_c_current
                    name: Phase C
                    icon: mdi:sine-wave
                  - type: divider
                  - entity: sensor.shellyem3_channel_a_voltage
                    name: Voltage A
                  - entity: sensor.shellyem3_channel_b_voltage
                    name: Voltage B
                  - entity: sensor.shellyem3_channel_c_voltage
                    name: Voltage C
          
          # Device Status
          - type: vertical-stack
            cards:
              - type: entities
                title: ğŸ”Œ Device Status
                show_header_toggle: false
                entities:
                  - entity: switch.sauna_channel_1
                    name: ğŸ§– Sauna (7kW)
                  - entity: switch.shellypro4pm_ec62609fd3dc_switch_2
                    name: ğŸ’§ Boiler (3kW)
                  - entity: switch.tesla_model_3_charger
                    name: ğŸš— Tesla
                  - entity: number.tesla_model_3_charging_amps
                    name: Tesla Amps
                  - entity: sensor.tesla_model_3_battery
                    name: Tesla Battery
                  - type: divider
                  - entity: switch.mh1
                    name: ğŸ›ï¸ MH1 Radiator
                  - entity: switch.shellypro4pm_ec62609fd3dc_switch_1
                    name: ğŸ‘¦ Tuomas Radiator
                  - entity: switch.shellypro4pm_ec62609fd3dc_switch_0
                    name: ğŸ‘§ Sara Radiator

      # Row 4: Today's Price Chart
      - type: custom:apexcharts-card
        header:
          show: true
          title: ğŸ’° Electricity Price Today - 24 Hours
          show_states: true
          colorize_states: true
        graph_span: 30h
        span:
          start: hour
          offset: '-2h'
        now:
          show: true
          label: NOW
        yaxis:
          - id: price
            min: 0
            max: ~50
            decimals: 0
        apex_config:
          chart:
            height: 280
          dataLabels:
            enabled: false
          xaxis:
            labels:
              format: 'HH:mm'
        series:
          - entity: sensor.current_electricity_cost_rate
            name: Total Price
            type: column
            group_by:
              func: last
              duration: 1h
            show:
              extremas: time
            color_threshold:
              - value: 0
                color: '#4ECDC4'
              - value: 12
                color: '#95E1D3'
              - value: 16
                color: '#FFE66D'
              - value: 20
                color: '#FF9A76'
              - value: 25
                color: '#FF6B6B'
              - value: 35
                color: '#FF0000'

      # Row 5: System Status
      - type: markdown
        content: |
          # ğŸ“Š System Status
          
          ## Current State
          - **Power:** {{ states('sensor.total_power_kw') }} kW / 17.25 kW ({{ (states('sensor.total_power_kw')|float / 17.25 * 100) | round(1) }}%)
          - **Price:** {{ states('sensor.current_electricity_cost_rate') }} c/kWh
          - **Kids Home:** {{ 'YES âœ…' if is_state('input_boolean.kids_home', 'on') else 'NO âŒ' }}
          - **Active Radiators:** {{ states.switch | selectattr('entity_id', 'in', ['switch.mh1', 'switch.shellypro4pm_ec62609fd3dc_switch_0', 'switch.shellypro4pm_ec62609fd3dc_switch_1']) | selectattr('state', 'eq', 'on') | list | count }} / 3
          
          ## Node-RED Flows
          - âœ… Temperature Control (Every 5 min)
          - âœ… Priority Load Balancer (Real-time)
          - âœ… Peak Power Limiter (<8kW)
          - âœ… Price Optimizer (Hourly)
          - âœ… Phase Monitor (Continuous)
        card_mod:
          style: |
            ha-card {
              background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            }

  # ==========================================================================
  # PAGE 2: CONTROL - Heating & Device Management
  # ==========================================================================
  - title: Control
    path: control
    icon: mdi:tune
    type: custom:vertical-layout
    badges: []
    cards:
      # Heating Control Header
      - type: markdown
        content: |
          # ğŸ  HEATING CONTROL CENTER
          
          Complete control over temperature automation and radiator management
        card_mod:
          style: |
            ha-card {
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              font-size: 18px;
              text-align: center;
            }

      # Kids Home Control
      - type: entities
        title: ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Kids Home Status & Settings
        show_header_toggle: false
        card_mod:
          style: |
            ha-card {
              border: 3px solid #667eea;
              background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            }
        entities:
          - entity: input_boolean.kids_home
            name: Kids at Home (Toggle every other week)
            icon: mdi:human-child
          - type: section
            label: Temperature Settings
          - entity: input_number.kids_rooms_target_temp
            name: Target Temperature (Kids Home)
            icon: mdi:thermometer-chevron-up
          - entity: input_number.kids_rooms_min_temp
            name: Minimum Temperature (Kids Away)
            icon: mdi:thermometer-chevron-down
          - type: section
            label: Current Status
          - type: custom:template-entity-row
            name: Tuomas Room
            state: '{{ states("sensor.aqara_poikienhuone_temperature") }}Â°C'
            secondary: 'Radiator: {{ states("switch.shellypro4pm_ec62609fd3dc_switch_1") }}'
            icon: mdi:account
          - type: custom:template-entity-row
            name: Sara Room
            state: '{{ states("sensor.aqara_saranhuone_temperature") }}Â°C'
            secondary: 'Radiator: {{ states("switch.shellypro4pm_ec62609fd3dc_switch_0") }}'
            icon: mdi:account

      # Kids Rooms Control
      - type: horizontal-stack
        cards:
          - type: vertical-stack
            cards:
              - type: sensor
                entity: sensor.aqara_poikienhuone_temperature
                name: ğŸ‘¦ Tuomas Room
                graph: line
                detail: 2
              - type: entities
                show_header_toggle: false
                entities:
                  - entity: switch.shellypro4pm_ec62609fd3dc_switch_1
                    name: Radiator Control
                    icon: mdi:radiator
          
          - type: vertical-stack
            cards:
              - type: sensor
                entity: sensor.aqara_saranhuone_temperature
                name: ğŸ‘§ Sara Room
                graph: line
                detail: 2
              - type: entities
                show_header_toggle: false
                entities:
                  - entity: switch.shellypro4pm_ec62609fd3dc_switch_0
                    name: Radiator Control
                    icon: mdi:radiator

      # Master Bedroom (MH1) Control
      - type: entities
        title: ğŸ›ï¸ Master Bedroom (MH1) - Schedule & Settings
        show_header_toggle: false
        card_mod:
          style: |
            ha-card {
              border: 3px solid #764ba2;
              background: linear-gradient(135deg, rgba(118, 75, 162, 0.05) 0%, rgba(102, 126, 234, 0.05) 100%);
            }
        entities:
          - type: section
            label: Current Status
          - entity: sensor.aqara_makuuhuone_temperature
            name: Current Temperature
            icon: mdi:thermometer
          - entity: switch.mh1
            name: Radiator Status
            icon: mdi:radiator
          - type: section
            label: Schedule Settings
          - entity: input_datetime.mh1_start_time
            name: Heating Start Time
            icon: mdi:clock-start
          - entity: input_datetime.mh1_end_time
            name: Heating End Time
            icon: mdi:clock-end
          - entity: input_number.mh1_target_temp
            name: Target Temperature
            icon: mdi:thermometer-chevron-up
          - type: section
            label: Override Controls
          - entity: input_boolean.mh1_manual_override
            name: 24/7 Manual Override
            icon: mdi:lock-open-variant

      # Temperature Chart
      - type: custom:apexcharts-card
        header:
          show: true
          title: ğŸŒ¡ï¸ Room Temperatures - 24 Hours
          show_states: true
          colorize_states: true
        graph_span: 24h
        now:
          show: true
        yaxis:
          - id: temp
            min: 15
            max: 25
            decimals: 1
        apex_config:
          chart:
            height: 300
          stroke:
            width: 3
            curve: smooth
          legend:
            show: true
            position: top
        series:
          - entity: sensor.aqara_makuuhuone_temperature
            name: ğŸ›ï¸ MH1 (Master)
            color: '#FF6B6B'
          - entity: sensor.aqara_poikienhuone_temperature
            name: ğŸ‘¦ Tuomas
            color: '#4ECDC4'
          - entity: sensor.aqara_saranhuone_temperature
            name: ğŸ‘§ Sara
            color: '#FFE66D'
          - entity: sensor.aqara_olohuone_temperature
            name: ğŸ›‹ï¸ Living Room
            color: '#95E1D3'
          - entity: sensor.aqara_keittio_temperature
            name: ğŸ³ Kitchen
            color: '#AA96DA'

      # Device Control
      - type: horizontal-stack
        cards:
          # Tesla
          - type: entities
            title: ğŸš— Tesla Control
            show_header_toggle: false
            card_mod:
              style: |
                ha-card {
                  background: linear-gradient(135deg, rgba(240, 147, 251, 0.1) 0%, rgba(245, 87, 108, 0.15) 100%);
                }
            entities:
              - entity: switch.tesla_model_3_charger
                name: Charger
              - entity: number.tesla_model_3_charging_amps
                name: Charging Amps (6-16A)
              - entity: sensor.tesla_model_3_battery
                name: Battery Level
              - type: section
              - type: attribute
                entity: switch.tesla_model_3_charger
                attribute: friendly_name
                name: Auto-Managed by Node-RED
                icon: mdi:robot

          # Other Devices
          - type: entities
            title: ğŸ”¥ Other Devices
            show_header_toggle: false
            entities:
              - entity: switch.shellypro4pm_ec62609fd3dc_switch_2
                name: Water Boiler (3kW)
                icon: mdi:water-boiler
              - entity: climate.mitsu_ilp
                name: Heat Pump
              - entity: switch.sauna_channel_1
                name: Sauna (7kW)
                icon: mdi:sauna
              - entity: binary_sensor.kiuas_tilatieto
                name: Sauna Heater Status

      # Priority Information
      - type: markdown
        content: |
          ## âš–ï¸ Priority Load Balancing
          
          **Automatic Priority Order:**
          1. ğŸ§– **Sauna** (7kW) - Always protected, highest priority
          2. ğŸ  **Heating** (Radiators) - Comfort priority
          3. ğŸ’§ **Boiler** (3kW) - Medium priority, flexible timing
          4. ğŸš— **Tesla** (variable) - Lowest priority, adjustable 6-16A
          
          **Tesla Adjustment Rules:**
          - Sauna ON â†’ Max 8A (~5.5kW)
          - Power >85% (14.66kW) â†’ Reduce by 2A
          - Power >95% (16.39kW) â†’ Minimum 6A or OFF
          
          **Peak Power Protection:**
          - 60-min average kept <8kW
          - Prevents tehomaksu fees (â‚¬8.38/month per 100W)
          - Expected savings: â‚¬100-200/year

  # ==========================================================================
  # PAGE 3: FLOWS - Node-RED Flow Visualization
  # ==========================================================================
  - title: Flows
    path: flows
    icon: mdi:sitemap
    type: custom:vertical-layout
    badges: []
    cards:
      # Flow Status Overview
      - type: markdown
        content: |
          # ğŸ”„ NODE-RED AUTOMATION FLOWS
          
          Visual representation of automation logic and decision trees
        card_mod:
          style: |
            ha-card {
              background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
              color: white;
              font-size: 18px;
              text-align: center;
            }

      # Flow Status Table
      - type: markdown
        content: |
          ## ğŸ“Š Flow Status Overview
          
          | Flow | Status | Trigger | Description |
          |------|--------|---------|-------------|
          | ğŸ  Temperature Control | {{ 'âœ… Active' if states('input_boolean.kids_home') else 'âœ… Active' }} | Every 5 min | Controls 3 radiators based on temp/schedule |
          | âš–ï¸ Priority Balancer | {{ 'âœ… Active' if states('sensor.total_power_kw') else 'âŒ Error' }} | Real-time | Manages device priority & Tesla amps |
          | âš¡ Peak Limiter | {{ 'âœ… Active' if states('sensor.total_power_kw') else 'âŒ Error' }} | Every 30s | Prevents >8kW 60-min average |
          | ğŸ’° Price Optimizer | {{ 'âœ… Active' if states('sensor.current_electricity_cost_rate') else 'âŒ Error' }} | Hourly | Heat pump scheduling |
          | ğŸ“¡ Phase Monitor | {{ 'âœ… Active' if states('sensor.shellyem3_channel_a_current') else 'âŒ Error' }} | Continuous | Voltage & alerts |
          
          **Last Updated:** {{ now().strftime('%H:%M:%S') }}
        card_mod:
          style: |
            ha-card {
              background: rgba(var(--rgb-primary-text-color), 0.05);
            }

      # Temperature Control Flow
      - type: markdown
        content: |
          ## ğŸ  Temperature Control Flow
          
          ```
          START (Every 5 minutes)
               â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Check Kids Home?   â”‚ â† input_boolean.kids_home
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   YES       â”‚     NO      â”‚
          â†“             â†“
          Target: {{ states('input_number.kids_rooms_target_temp') }}Â°C    Minimum: {{ states('input_number.kids_rooms_min_temp') }}Â°C
          
          For each room:
          â”œâ”€ ğŸ‘¦ Tuomas: {{ states('sensor.aqara_poikienhuone_temperature') }}Â°C
          â”‚  â””â”€ Radiator: {{ 'ON ğŸ”¥' if is_state('switch.shellypro4pm_ec62609fd3dc_switch_1', 'on') else 'OFF â„ï¸' }}
          â”œâ”€ ï¿½ï¿½ Sara: {{ states('sensor.aqara_saranhuone_temperature') }}Â°C
          â”‚  â””â”€ Radiator: {{ 'ON ğŸ”¥' if is_state('switch.shellypro4pm_ec62609fd3dc_switch_0', 'on') else 'OFF â„ï¸' }}
          â””â”€ ğŸ›ï¸ MH1: {{ states('sensor.aqara_makuuhuone_temperature') }}Â°C
             â”œâ”€ Schedule: {{ states('input_datetime.mh1_start_time')[:5] }}-{{ states('input_datetime.mh1_end_time')[:5] }}
             â”œâ”€ Override: {{ 'ON' if is_state('input_boolean.mh1_manual_override', 'on') else 'OFF' }}
             â””â”€ Radiator: {{ 'ON ğŸ”¥' if is_state('switch.mh1', 'on') else 'OFF â„ï¸' }}
          
          Decision Logic (per room):
          IF temp < target - 0.5Â°C â†’ Turn ON ğŸ”¥
          IF temp > target + 0.5Â°C â†’ Turn OFF â„ï¸
          ELSE â†’ Keep current state â¸ï¸
          ```
        card_mod:
          style: |
            ha-card {
              background: rgba(var(--rgb-primary-text-color), 0.05);
              font-family: monospace;
            }

      # Priority Load Balancer Flow
      - type: markdown
        content: |
          ## âš–ï¸ Priority Load Balancer Flow
          
          ```
          START (Power change detected)
               â†“
          Current Power: {{ states('sensor.total_power_kw') }} kW
          Capacity: {{ (states('sensor.total_power_kw')|float / 17.25 * 100) | round(1) }}%
               â†“
          Priority Order:
          1ï¸âƒ£ Sauna: {{ 'ON ğŸ§–' if is_state('switch.sauna_channel_1', 'on') else 'OFF' }} (7kW - Protected)
          2ï¸âƒ£ Heating: {{ states.switch | selectattr('entity_id', 'in', ['switch.mh1', 'switch.shellypro4pm_ec62609fd3dc_switch_0', 'switch.shellypro4pm_ec62609fd3dc_switch_1']) | selectattr('state', 'eq', 'on') | list | count }}/3 ON (Protected)
          3ï¸âƒ£ Boiler: {{ 'ON ğŸ’§' if is_state('switch.shellypro4pm_ec62609fd3dc_switch_2', 'on') else 'OFF' }} (3kW)
          4ï¸âƒ£ Tesla: {{ 'ON ğŸš—' if is_state('switch.tesla_model_3_charger', 'on') else 'OFF' }} ({{ states('number.tesla_model_3_charging_amps') }}A - Adjustable)
               â†“
          Tesla Adjustment:
          {% if is_state('switch.sauna_channel_1', 'on') %}
          â””â”€ Sauna ON â†’ Tesla max 8A
          {% elif (states('sensor.total_power_kw')|float / 17.25) > 0.95 %}
          â””â”€ Power >95% â†’ Tesla 6A or OFF
          {% elif (states('sensor.total_power_kw')|float / 17.25) > 0.85 %}
          â””â”€ Power >85% â†’ Reduce Tesla by 2A
          {% else %}
          â””â”€ Normal operation (6-16A range)
          {% endif %}
          ```
        card_mod:
          style: |
            ha-card {
              background: rgba(var(--rgb-primary-text-color), 0.05);
              font-family: monospace;
            }

      # Peak Power Limiter
      - type: markdown
        content: |
          ## âš¡ Peak Power Limiter (Tehomaksu Prevention)
          
          ```
          Purpose: Keep 60-min average <8kW
          Cost to avoid: â‚¬8.38/month per 100W over threshold
               â†“
          Current Power: {{ states('sensor.total_power_kw') }} kW
          Status: {% set power = states('sensor.total_power_kw')|float %}{% if power < 7.5 %}âœ… SAFE{% elif power < 8.0 %}âš ï¸ WARNING{% else %}ğŸ”´ CRITICAL{% endif %}
               â†“
          Thresholds:
          â”œâ”€ 7.5kW: Early warning
          â”œâ”€ 8.0kW: Start reduction
          â””â”€ Action sequence:
             1. Reduce Tesla to 6A
             2. Turn OFF boiler (30 min)
             3. Send alert
          
          Expected Savings: â‚¬100-200/year
          ```
        card_mod:
          style: |
            ha-card {
              background: rgba(var(--rgb-primary-text-color), 0.05);
              font-family: monospace;
            }

      # Price Optimizer
      - type: markdown
        content: |
          ## ğŸ’° Price-Based Optimizer
          
          ```
          Current Price: {{ states('sensor.current_electricity_cost_rate') }} c/kWh
          Category: {% set price = states('sensor.current_electricity_cost_rate')|float %}{% if price < 12 %}ğŸ’š VERY CHEAP{% elif price < 16 %}ğŸ’› CHEAP{% elif price < 20 %}ğŸŸ  MODERATE{% elif price < 25 %}ğŸ”´ EXPENSIVE{% else %}â›” VERY EXPENSIVE{% endif %}
               â†“
          Heat Pump Action:
          {% if price < 12 %}
          â””â”€ Boost +2Â°C (heat storage)
          {% elif price < 20 %}
          â””â”€ Normal target temperature
          {% elif price < 25 %}
          â””â”€ Eco mode -1Â°C
          {% else %}
          â””â”€ OFF (emergency only)
          {% endif %}
          
          Expected Savings: â‚¬150-250/year
          ```
        card_mod:
          style: |
            ha-card {
              background: rgba(var(--rgb-primary-text-color), 0.05);
              font-family: monospace;
            }

  # ==========================================================================
  # PAGE 4: STATISTICS - Analysis & Reporting
  # ==========================================================================
  - title: Statistics
    path: statistics
    icon: mdi:chart-box
    type: custom:vertical-layout
    badges: []
    cards:
      # Statistics Header
      - type: markdown
        content: |
          # ğŸ“ˆ STATISTICS & ANALYSIS
          
          Historical data and cost tracking
        card_mod:
          style: |
            ha-card {
              background: linear-gradient(135deg, #FA8BFF 0%, #2BD2FF 90%);
              color: white;
              font-size: 18px;
              text-align: center;
            }

      # Monthly Summary
      - type: horizontal-stack
        cards:
          - type: gauge
            entity: sensor.sahko_hinnan_korjaus_kuukausi
            name: This Month Cost
            min: 0
            max: 500
            needle: true
            unit: 'â‚¬'
            severity:
              green: 0
              yellow: 300
              red: 420
          
          - type: gauge
            entity: sensor.talon_kokonaiskulutus_kuukausi_kwh
            name: This Month Consumption
            min: 0
            max: 2000
            needle: true
            unit: kWh
            severity:
              green: 0
              yellow: 1300
              red: 1700

      # Consumption Breakdown
      - type: entities
        title: ğŸ“Š Consumption Summary
        show_header_toggle: false
        entities:
          - type: section
            label: Energy
          - entity: sensor.talon_kokonaiskulutus_paiva_kwh
            name: Today
            icon: mdi:calendar-today
          - entity: sensor.talon_kokonaiskulutus_viikko_kwh
            name: This Week
            icon: mdi:calendar-week
          - entity: sensor.talon_kokonaiskulutus_kuukausi_kwh
            name: This Month
            icon: mdi:calendar-month
          - type: section
            label: Costs
          - entity: sensor.sahko_hinnan_korjaus_paiva
            name: Today
            icon: mdi:currency-eur
          - entity: sensor.sahko_hinnan_korjaus_viikko
            name: This Week
            icon: mdi:currency-eur
          - entity: sensor.sahko_hinnan_korjaus_kuukausi
            name: This Month
            icon: mdi:currency-eur

      # 30-Day Consumption Trend
      - type: custom:apexcharts-card
        header:
          show: true
          title: ğŸ“Š 30-Day Consumption Trend
          show_states: true
        graph_span: 30d
        span:
          start: day
        apex_config:
          chart:
            height: 300
          stroke:
            width: 2
        series:
          - entity: sensor.talon_kokonaiskulutus_paiva_kwh
            name: Daily Consumption
            type: column
            color: '#4ECDC4'
            group_by:
              func: last
              duration: 1d

      # Best Charging Windows
      - type: markdown
        content: |
          ## âš¡ Best Charging Window Tomorrow
          
          {{ states('sensor.best_charging_window_tomorrow') }}
          
          ---
          
          ğŸ• **Time:** {{ state_attr('sensor.best_charging_window_tomorrow', 'start_time') }} - {{ state_attr('sensor.best_charging_window_tomorrow', 'end_time') }}
          
          ğŸ’° **Average Price:** {{ state_attr('sensor.best_charging_window_tomorrow', 'average_price') }} c/kWh
          
          ğŸ’µ **Savings:** {{ state_attr('sensor.best_charging_window_tomorrow', 'savings') }} â‚¬ vs worst window
          
          ğŸ“Š **Estimated Cost:** {{ state_attr('sensor.best_charging_window_tomorrow', 'estimated_cost') }} â‚¬ for full charge
        card_mod:
          style: |
            ha-card {
              background: linear-gradient(135deg, rgba(168, 237, 234, 0.3) 0%, rgba(254, 214, 227, 0.3) 100%);
            }

      # Savings Summary
      - type: markdown
        content: |
          ## ğŸ’° Expected Savings (Phase 2)
          
          ### Monthly Breakdown
          
          | Category | Savings | Details |
          |----------|---------|---------|
          | ğŸ  Smart Heating | â‚¬12-16 | MH1 night-only schedule |
          | ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Kids Away Mode | â‚¬6-8 | Minimum temp when away |
          | âš¡ Tehomaksu Avoidance | â‚¬16-24 | Peak power <8kW |
          | ğŸ’° Price Optimization | â‚¬0-8 | Heat pump cheap hours |
          | **Total Monthly** | **â‚¬34-48** | **System automation** |
          
          ---
          
          ### Annual Projection
          - **Minimum:** â‚¬408/year
          - **Expected:** â‚¬480/year
          - **Maximum:** â‚¬576/year
          
          ### Current Status
          - Kids Home: {{ 'Active âœ…' if is_state('input_boolean.kids_home', 'on') else 'Away Mode ğŸ’¤' }}
          - MH1 Schedule: {{ states('input_datetime.mh1_start_time')[:5] }}-{{ states('input_datetime.mh1_end_time')[:5] }}
          - Active Radiators: {{ states.switch | selectattr('entity_id', 'in', ['switch.mh1', 'switch.shellypro4pm_ec62609fd3dc_switch_0', 'switch.shellypro4pm_ec62609fd3dc_switch_1']) | selectattr('state', 'eq', 'on') | list | count }}/3
          - Peak Power Status: {% set power = states('sensor.total_power_kw')|float %}{% if power < 7.5 %}âœ… Safe{% elif power < 8.0 %}âš ï¸ Close to limit{% else %}ğŸ”´ Over limit{% endif %}
        card_mod:
          style: |
            ha-card {
              background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            }
