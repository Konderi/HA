# ============================================
# ELECTRICITY PRICING - COMPLETE SYSTEM
# Based on Spot-Hinta.fi API + Your Contract
# ============================================
# 
# ⚠️ IMPORTANT: All pricing constants are defined in:
#    electricity_pricing_constants.yaml
# 
# To change prices, edit the constants file, NOT here!
#
# Requires:
# - sensor.shf_electricity_price_now (Spot-Hinta.fi)
# - input_number.electricity_* (from constants file)
# ============================================

template:
  - sensor:
      # ====================
      # TRANSFER TARIFF (DAY/NIGHT)
      # Uses values from electricity_pricing_constants.yaml
      # ====================
      - name: "Transfer Tariff Now"
        unique_id: transfer_tariff_now
        unit_of_measurement: "€/kWh"
        device_class: monetary
        state: >
          {% set hour = now().hour %}
          {% set day_start = states('input_number.electricity_day_tariff_start_hour') | int(7) %}
          {% set day_end = states('input_number.electricity_day_tariff_end_hour') | int(22) %}
          {% set day_fee = states('input_number.electricity_transfer_day_eur') | float(0.0511) %}
          {% set night_fee = states('input_number.electricity_transfer_night_eur') | float(0.0312) %}
          {{ day_fee if day_start <= hour < day_end else night_fee }}
        icon: >
          {% set hour = now().hour %}
          {% set day_start = states('input_number.electricity_day_tariff_start_hour') | int(7) %}
          {% set day_end = states('input_number.electricity_day_tariff_end_hour') | int(22) %}
          {{ 'mdi:weather-sunny' if day_start <= hour < day_end else 'mdi:weather-night' }}
        attributes:
          tariff_type: >
            {% set hour = now().hour %}
            {% set day_start = states('input_number.electricity_day_tariff_start_hour') | int(7) %}
            {% set day_end = states('input_number.electricity_day_tariff_end_hour') | int(22) %}
            {{ 'Day' if day_start <= hour < day_end else 'Night' }}
          tariff_cents: >
            {% set hour = now().hour %}
            {% set day_start = states('input_number.electricity_day_tariff_start_hour') | int(7) %}
            {% set day_end = states('input_number.electricity_day_tariff_end_hour') | int(22) %}
            {% set day_fee = states('input_number.electricity_transfer_day_eur') | float(0.0511) %}
            {% set night_fee = states('input_number.electricity_transfer_night_eur') | float(0.0312) %}
            {{ (day_fee * 100) | round(2) if day_start <= hour < day_end else (night_fee * 100) | round(2) }}
          start_time: >
            {% set hour = now().hour %}
            {% set day_start = states('input_number.electricity_day_tariff_start_hour') | int(7) %}
            {% set day_end = states('input_number.electricity_day_tariff_end_hour') | int(22) %}
            {{ '%02d:00' | format(day_start) if day_start <= hour < day_end else '%02d:00' | format(day_end) }}
          end_time: >
            {% set hour = now().hour %}
            {% set day_start = states('input_number.electricity_day_tariff_start_hour') | int(7) %}
            {% set day_end = states('input_number.electricity_day_tariff_end_hour') | int(22) %}
            {{ '%02d:00' | format(day_end) if day_start <= hour < day_end else '%02d:00' | format(day_start) }}

      # ====================
      # TOTAL ELECTRICITY PRICE (ALL COMPONENTS)
      # All values from electricity_pricing_constants.yaml
      # ====================
      - name: "Electricity Total Price Now"
        unique_id: electricity_total_price_now
        unit_of_measurement: "€/kWh"
        device_class: monetary
        state_class: measurement
        state: >
          {% set spot = states('sensor.shf_electricity_price_now') | float(0) %}
          {% set tax = states('input_number.electricity_tax_eur') | float(0.02827515) %}
          {% set margin = states('input_number.electricity_margin_eur') | float(0.0059) %}
          {% set transfer = states('sensor.transfer_tariff_now') | float(0.0511) %}
          {{ (spot + tax + margin + transfer) | round(5) }}
        icon: mdi:currency-eur
        attributes:
          spot_price: '{{ states("sensor.shf_electricity_price_now") | float(0) | round(5) }}'
          electric_tax: '{{ states("input_number.electricity_tax_eur") | float(0) | round(5) }}'
          margin: '{{ states("input_number.electricity_margin_eur") | float(0) | round(5) }}'
          transfer_fee: '{{ states("sensor.transfer_tariff_now") | float(0) | round(5) }}'
          spot_price_cents: '{{ (states("sensor.shf_electricity_price_now") | float(0) * 100) | round(2) }}'
          electric_tax_cents: '{{ (states("input_number.electricity_tax_eur") | float(0) * 100) | round(2) }}'
          margin_cents: '{{ (states("input_number.electricity_margin_eur") | float(0) * 100) | round(2) }}'
          transfer_fee_cents: '{{ (states("sensor.transfer_tariff_now") | float(0) * 100) | round(2) }}'
          total_cents: '{{ (this.state | float(0) * 100) | round(2) }}'
          rank: '{{ states("sensor.shf_rank_now") }}'
          tariff_type: '{{ state_attr("sensor.transfer_tariff_now", "tariff_type") }}'

      # ====================
      # PRICE IN CENTS (FOR CHARTS)
      # ====================
      - name: "Electricity Total Price Cents"
        unique_id: electricity_total_price_cents
        unit_of_measurement: "c/kWh"
        device_class: monetary
        state: >
          {{ (states('sensor.electricity_total_price_now') | float(0) * 100) | round(2) }}
        icon: mdi:cash-100

      # ====================
      # HOURLY COST (CURRENT CONSUMPTION)
      # ====================
      - name: "Electricity Cost Now"
        unique_id: electricity_cost_now
        unit_of_measurement: "€/h"
        device_class: monetary
        state: >
          {% set power_kw = states('sensor.total_power_consumption') | float(0) %}
          {% set price = states('sensor.electricity_total_price_now') | float(0) %}
          {{ (power_kw * price) | round(3) }}
        icon: mdi:currency-eur-off
        attributes:
          power_kw: '{{ states("sensor.total_power_consumption") | float(0) | round(2) }}'
          price_per_kwh: '{{ states("sensor.electricity_total_price_now") | float(0) | round(5) }}'
          cost_per_minute: '{{ (this.state | float(0) / 60) | round(4) }}'

      # ====================
      # DAILY STATISTICS
      # ====================
      - name: "Electricity Average Price Today"
        unique_id: electricity_average_price_today
        unit_of_measurement: "€/kWh"
        device_class: monetary
        state: >
          {% set spot_avg = state_attr('sensor.shf_electricity_price_now', 'today_avg') | float(0) %}
          {% set tax = states('input_number.electricity_tax_eur') | float(0.02827515) %}
          {% set margin = states('input_number.electricity_margin_eur') | float(0.0059) %}
          {% set day_start = states('input_number.electricity_day_tariff_start_hour') | int(7) %}
          {% set day_end = states('input_number.electricity_day_tariff_end_hour') | int(22) %}
          {% set day_hours = day_end - day_start %}
          {% set night_hours = 24 - day_hours %}
          {% set transfer_day = states('input_number.electricity_transfer_day_eur') | float(0.0511) %}
          {% set transfer_night = states('input_number.electricity_transfer_night_eur') | float(0.0312) %}
          {% set avg_transfer = (transfer_day * day_hours + transfer_night * night_hours) / 24 %}
          {{ (spot_avg + tax + margin + avg_transfer) | round(5) }}
        icon: mdi:chart-line
        attributes:
          spot_average: '{{ state_attr("sensor.shf_electricity_price_now", "today_avg") | float(0) | round(5) }}'
          day_hours: '{{ states("input_number.electricity_day_tariff_end_hour") | int(22) - states("input_number.electricity_day_tariff_start_hour") | int(7) }}'
          night_hours: '{{ 24 - (states("input_number.electricity_day_tariff_end_hour") | int(22) - states("input_number.electricity_day_tariff_start_hour") | int(7)) }}'
          weighted_transfer: >
            {% set day_start = states('input_number.electricity_day_tariff_start_hour') | int(7) %}
            {% set day_end = states('input_number.electricity_day_tariff_end_hour') | int(22) %}
            {% set day_hours = day_end - day_start %}
            {% set night_hours = 24 - day_hours %}
            {% set transfer_day = states('input_number.electricity_transfer_day_eur') | float(0.0511) %}
            {% set transfer_night = states('input_number.electricity_transfer_night_eur') | float(0.0312) %}
            {{ ((transfer_day * day_hours + transfer_night * night_hours) / 24) | round(5) }}

      - name: "Electricity Min Price Today"
        unique_id: electricity_min_price_today
        unit_of_measurement: "€/kWh"
        device_class: monetary
        state: >
          {% set spot_min = state_attr('sensor.shf_electricity_price_now', 'today_min') | float(0) %}
          {% set tax = states('input_number.electricity_tax_eur') | float(0.02827515) %}
          {% set margin = states('input_number.electricity_margin_eur') | float(0.0059) %}
          {% set transfer_night = states('input_number.electricity_transfer_night_eur') | float(0.0312) %}
          {{ (spot_min + tax + margin + transfer_night) | round(5) }}
        icon: mdi:arrow-down-bold

      - name: "Electricity Max Price Today"
        unique_id: electricity_max_price_today
        unit_of_measurement: "€/kWh"
        device_class: monetary
        state: >
          {% set spot_max = state_attr('sensor.shf_electricity_price_now', 'today_max') | float(0) %}
          {% set tax = states('input_number.electricity_tax_eur') | float(0.02827515) %}
          {% set margin = states('input_number.electricity_margin_eur') | float(0.0059) %}
          {% set transfer_day = states('input_number.electricity_transfer_day_eur') | float(0.0511) %}
          {{ (spot_max + tax + margin + transfer_day) | round(5) }}
        icon: mdi:arrow-up-bold

      # ====================
      # MONTHLY ESTIMATES
      # ====================
      - name: "Electricity Monthly Base Fee"
        unique_id: electricity_monthly_base_fee
        unit_of_measurement: "€"
        device_class: monetary
        state: >
          {{ states('input_number.electricity_base_fee_monthly') | float(5.99) | round(2) }}
        icon: mdi:calendar-month
        attributes:
          description: "Fixed monthly base fee (incl. ALV 25.5%)"
          yearly_total: >
            {{ (states('input_number.electricity_base_fee_monthly') | float(5.99) * 12) | round(2) }}

      - name: "Electricity Estimated Monthly Cost"
        unique_id: electricity_estimated_monthly_cost
        unit_of_measurement: "€"
        device_class: monetary
        state: >
          {% set daily_kwh = states('sensor.energy_daily') | float(0) %}
          {% set avg_price = states('sensor.electricity_average_price_today') | float(0) %}
          {% set base_fee = states('input_number.electricity_base_fee_monthly') | float(5.99) %}
          {% set monthly_energy_cost = daily_kwh * avg_price * 30 %}
          {{ (monthly_energy_cost + base_fee) | round(2) }}
        icon: mdi:calculator
        attributes:
          daily_consumption_kwh: '{{ states("sensor.energy_daily") | float(0) | round(1) }}'
          monthly_consumption_kwh: '{{ (states("sensor.energy_daily") | float(0) * 30) | round(0) }}'
          energy_cost: '{{ (states("sensor.energy_daily") | float(0) * states("sensor.electricity_average_price_today") | float(0) * 30) | round(2) }}'
          base_fee: '{{ states("input_number.electricity_base_fee_monthly") | float(5.99) | round(2) }}'

      # ====================
      # SAVINGS TRACKING
      # ====================
      - name: "Electricity Savings This Month"
        unique_id: electricity_savings_this_month
        unit_of_measurement: "€"
        device_class: monetary
        state: >
          {% set saved_from_peak = states('sensor.nodered_saved_euros') | float(0) %}
          {% set saved_from_optimization = states('sensor.price_optimization_savings') | float(0) %}
          {{ (saved_from_peak + saved_from_optimization) | round(2) }}
        icon: mdi:piggy-bank
        attributes:
          peak_limiter_savings: '{{ states("sensor.nodered_saved_euros") | float(0) | round(2) }}'
          price_optimization_savings: '{{ states("sensor.price_optimization_savings") | float(0) | round(2) }}'
          interventions_count: '{{ states("sensor.nodered_interventions_count") | float(0) | int }}'

  - binary_sensor:
      # ====================
      # PRICING STATUS
      # ====================
      - name: "Electricity Price Cheap Now"
        unique_id: electricity_price_cheap_now
        device_class: power
        state: >
          {% set rank = states('sensor.shf_rank_now') | int(24) %}
          {{ rank <= 8 }}
        icon: >
          {% set rank = states('sensor.shf_rank_now') | int(24) %}
          {{ 'mdi:currency-eur-off' if rank <= 8 else 'mdi:currency-eur' }}
        attributes:
          current_rank: '{{ states("sensor.shf_rank_now") }}'
          threshold_rank: 8
          description: "Price is in cheapest 1/3 of day"

      - name: "Electricity Price Expensive Now"
        unique_id: electricity_price_expensive_now
        device_class: problem
        state: >
          {% set rank = states('sensor.shf_rank_now') | int(0) %}
          {{ rank >= 18 }}
        icon: >
          {% set rank = states('sensor.shf_rank_now') | int(0) %}
          {{ 'mdi:alert' if rank >= 18 else 'mdi:check-circle' }}
        attributes:
          current_rank: '{{ states("sensor.shf_rank_now") }}'
          threshold_rank: 18
          description: "Price is in most expensive 1/4 of day"

      - name: "Night Tariff Active"
        unique_id: night_tariff_active
        state: >
          {% set hour = now().hour %}
          {{ hour < 7 or hour >= 22 }}
        icon: >
          {% set hour = now().hour %}
          {{ 'mdi:weather-night' if (hour < 7 or hour >= 22) else 'mdi:weather-sunny' }}
